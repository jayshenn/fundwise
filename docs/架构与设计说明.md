# fundwise 架构与设计说明

## 1. 文档目的

本文档用于明确 `fundwise` 的实现边界和技术方案，指导后续按统一契约开发，避免在数据口径、模块职责和接口调用上反复返工。

## 2. 产品定位与范围

- 定位：A 股与港股投研决策支持系统。
- 目标：提升公司分析、选股、择时研究效率。
- 非目标：自动交易执行、高频/超短线系统、短期价格预测系统。

## 3. 设计原则

- 契约优先：先定义输入输出和字段口径，再实现功能。
- 数据分层：原始数据、标准化数据、分析结论分层管理。
- 可回溯：报告中的结论可追溯到原始数据和计算规则。
- 可替换：AkShare 接口变动时，尽量只改 `data_adapter`。
- 小步迭代：先跑通单公司闭环，再扩展到选股和择时。

## 4. 技术栈

- 依赖与环境管理：`uv`
- 项目配置：`pyproject.toml`
- 代码检查与格式化：`ruff`
- 测试框架：`pytest`
- 类型检查：`pyright`

## 5. 总体架构

```text
AkShare API
   |
   v
data_adapter (接口封装/字段映射/代码格式转换/容错)
   |
   v
normalized dataset (统一字段 + 统一口径)
   |-------------------|--------------------|
   v                   v                    v
company_dossier   watchlist_screener   market_timing_panel
   |                   |                    |
   --------------------|--------------------
                       v
                 report_engine (Markdown/图表)
                       |
                       v
                 reports/ 输出产物
```

## 6. 模块职责

### 6.1 `data_adapter`

- 输入：标准 `symbol`（`600519.SH` / `00700.HK`）与时间范围。
- 输出：统一字段的数据表。
- 责任：
  - AkShare 接口调用。
  - 参数格式转换（如 `600519`、`SH600519`、`00700`）。
  - 字段重命名与口径统一。
  - 网络重试、异常分类、降级策略。

### 6.2 `company_dossier`

- 基于统一字段生成单公司分析卡：
  - 规模与增长（营收、利润、市值）。
  - 质量与现金流（ROE、经营现金流）。
  - 资产负债结构（总资产、总负债、资产负债率）。
  - 估值位置（公司/行业/指数 PE 对比 + PE 均值与标准差区间）。

### 6.3 `watchlist_screener`

- 建立候选池与评分卡，不输出交易信号。
- 评分示例：基本面质量、估值安全边际、资金面、催化剂。

### 6.4 `market_timing_panel`

- 输出市场状态而非买卖点。
- 产物：风险偏好温度、行业强弱、仓位区间建议。

### 6.5 `report_engine`

- 将结构化结果转换为报告：
  - 日报/周报。
  - 单公司卡片。
  - 观察池变动摘要。

## 7. 数据契约

### 7.1 统一主键与时间

- `symbol`：统一为 `600519.SH` / `00700.HK`
- `date`：统一为 `YYYY-MM-DD`
- `currency`：保留币种（`CNY` / `HKD`）

### 7.2 核心字段

- `market_cap`
- `revenue`
- `net_profit`
- `ocf`
- `pe_ttm`
- `roe`
- `total_assets`
- `total_liabilities`
- `debt_to_asset`（统一按 `total_liabilities / total_assets` 计算）

### 7.3 口径要求

- 营收：固定“营业总收入”或“主营业务收入”其一，不混用。
- 净利润：优先归母口径。
- ROE：保持加权平均或摊薄口径一致。
- 估值：优先 TTM，缺失时明确降级到静态口径。

### 7.4 存储策略（已确认）

- 采用混合存储：`SQLite`（元数据与索引）+ 文件存储（时序明细数据）。
- `SQLite` 负责：
  - 股票池与基础元数据管理。
  - 数据更新任务状态与错误日志。
  - 数据快照与报告文件索引。
  - 汇率表（跨币种比较所需）。
- 文件存储负责：
  - 原始与标准化明细数据（优先 `parquet`）。
  - 报告图表与 Markdown 产物。
- 原则：分析层优先通过索引定位文件，不直接扫描全量目录。

#### SQLite 最小表结构（MVP）

| 表名 | 作用 | 核心字段（示例） |
| --- | --- | --- |
| `symbols` | 股票池与基础信息 | `symbol`(PK), `market`, `name`, `currency`, `is_active`, `updated_at` |
| `data_jobs` | 数据更新任务日志 | `job_id`(PK), `job_type`, `symbol`, `status`, `started_at`, `finished_at`, `error_message` |
| `dataset_snapshots` | 数据快照索引 | `snapshot_id`(PK), `symbol`, `dataset_type`, `as_of_date`, `file_path`, `row_count`, `checksum`, `created_at` |
| `reports` | 报告索引 | `report_id`(PK), `symbol`, `report_type`, `report_date`, `file_path`, `generated_at` |
| `fx_rates` | 汇率表 | `date`, `base_currency`, `quote_currency`, `rate`, `source`（联合主键） |

> 说明：MVP 阶段不要求将全量行情/财报明细入库 SQLite，先以文件为主，索引入库。

## 8. 容错与降级策略

- 网络/TLS 抖动：重试 + 指数退避。
- 接口失效：
  - 先记录错误并标记数据缺口。
  - 可切换备用接口或降级图表展示。
- 字段变更：
  - 由 live 契约测试第一时间发现。
  - 仅在 `data_adapter` 修复映射，分析层不直接改。

## 9. 质量保障与测试策略

### 9.1 测试分层

- 合约测试（live）：
  - 个股接口：`tests/test_akshare_live_contracts.py`
  - 行业接口：`tests/test_akshare_live_industry_contracts.py`
- 逻辑测试（后续）：
  - 字段映射函数单测。
  - 评分卡计算单测。
  - 报告渲染快照测试。

### 9.2 运行命令

- 默认：`uv run pytest -q`
- live：`uv run env RUN_AKSHARE_TESTS=1 pytest -q -m akshare_live -s`
- 严格模式：`uv run env RUN_AKSHARE_TESTS=1 AKSHARE_STRICT=1 pytest -q -m akshare_live -s`
- Lint：`uv run ruff check .`
- Format：`uv run ruff format .`
- Type check：`uv run pyright`

## 10. 目录规划

```text
src/
  fundwise/
    data_adapter/
    company_dossier/
    watchlist_screener/
    market_timing_panel/
    report_engine/
scripts/
tests/
docs/
data/
  raw/
  normalized/
  metadata/
    fundwise.db
reports/
```

## 11. 实施路线图

### Phase 1：单公司闭环（MVP）

- 完成 `data_adapter` 的 A/H 单公司拉数与标准化。
- 输出单公司 Markdown 报告（含核心图表）。
- 验收：输入 `600519.SH` 可生成可读报告。

### Phase 2：候选池筛选

- 实现评分卡与排序。
- 输出观察池与入选理由。

### Phase 3：择时面板

- 增加市场状态指标与仓位区间建议。
- 输出周度策略摘要。

### Phase 4：自动化与运营

- 定时更新、失败告警、结果归档。
- 形成稳定的投研生产流程。

## 12. 当前已完成

- `uv` 依赖与环境管理接入。
- `ruff` / `pytest` / `pyright` 基础规范落地。
- AkShare 个股与行业 live 合约测试落地并可运行。
- `data_adapter` 已支持 A/H 标准化 symbol、行情/市值/核心财务字段拉取与字段统一。
- `SQLite` 元数据库已支持初始化、数据快照索引写入与报告索引写入。
- `SQLite` 已支持股票池基础信息维护（`symbols`）与任务日志管理（`data_jobs`）。
- `SQLite` 已支持汇率表维护与查询（`fx_rates`），并可解析 `currency -> CNY` 折算汇率。
- `company_dossier + report_engine` 已实现单公司 Markdown 分析卡输出与图表渲染（MVP）。
- 单公司图表已支持“8 图”框架：市值营收、双现金流质量、PE 对比、PE 统计带、ROE 对比、资产负债结构与负债率趋势。
- `company_dossier` 已支持 `fx_to_cny` 与关键指标 CNY 折算字段输出（缺失汇率时降级为 `N/A`）。
- `watchlist_screener` 已实现观察池评分、排序与 Markdown/CSV 报告输出（MVP）。
- `market_timing_panel` 已实现风险温度、市场状态、仓位区间建议与 Markdown/CSV 报告输出（MVP）。
- 已新增 `pipeline` 日常批处理流水线：支持按日期归档、失败汇总、非零退出码告警语义与执行摘要输出。
- 已新增流水线运维能力：任务日志查询、健康检查脚本、运行历史报告生成与索引登记。

## 13. 设计决策（已确认）

- 跨币种比较：统一折算为 `CNY` 后再做横向比较，同时保留原始 `currency` 与汇率字段（如 `fx_to_cny`）以支持追溯。
- 行业口径：采用“内部统一口径 + 外部映射表”模式。外部数据源可保留原分类体系，分析层统一消费内部 `industry_l1/l2` 字段。
- 图表引擎：MVP 阶段优先 `matplotlib`（稳定产出 PNG/Markdown）；交互式分析阶段再增补 `plotly`。
- 存储方案：MVP 采用 `SQLite + parquet` 混合模式，先解决索引与可追溯，再逐步扩展数据库承载范围。
